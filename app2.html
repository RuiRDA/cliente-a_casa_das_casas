<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Escalas de Trabalho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .config-panel {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        .calendar-day.off { background-color: #fca5a5; color: #7f1d1d; }
        .calendar-day.vacation { background-color: #93c5fd; color: #1e3a8a; }
        .calendar-day.selected { border: 2px solid #2563eb; }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="flex flex-col lg:flex-row min-h-screen">
        <!-- Painel de Configuração -->
        <div id="config-panel" class="w-full lg:w-1/3 bg-white p-6 shadow-lg overflow-y-auto config-panel">
            <h1 class="text-2xl font-bold mb-6 text-gray-900">Configuração da Escala</h1>

            <!-- Mês e Ano -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3">Período</h2>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="month-select" class="block text-sm font-medium text-gray-700">Mês</label>
                        <select id="month-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            <!-- Options preenchidas por JS -->
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label for="year-input" class="block text-sm font-medium text-gray-700">Ano</label>
                        <input type="number" id="year-input" value="2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>
            
            <!-- Colaboradores -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3">Colaboradores</h2>
                <div id="employee-list" class="space-y-2"></div>
                <div class="flex mt-3 space-x-2">
                    <input type="text" id="new-employee-name" placeholder="Nome do colaborador" class="flex-grow rounded-md border-gray-300 shadow-sm sm:text-sm">
                    <button id="add-employee-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">Adicionar</button>
                </div>
            </div>

            <!-- Férias e Folgas -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3">Férias e Folgas</h2>
                <label for="employee-select-calendar" class="block text-sm font-medium text-gray-700 mb-2">Selecione o Colaborador</label>
                <select id="employee-select-calendar" class="block w-full rounded-md border-gray-300 shadow-sm mb-4"></select>
                <div class="flex space-x-2 mb-4">
                    <button id="mark-vacation-btn" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">Marcar Férias</button>
                    <button id="mark-off-btn" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">Marcar Folga</button>
                     <button id="clear-day-btn" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm">Limpar Dia</button>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>

            <!-- Regras -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold mb-3">Regras e Preferências</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Pares Preferenciais (um por linha, ex: Nome1 + Nome2)</label>
                        <textarea id="preferred-pairs" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Dias Preferenciais (ex: Nome: DiaDaSemana)</label>
                        <textarea id="preferred-days" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></textarea>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Regras Especiais (ex: Nome: Regra)</label>
                        <textarea id="special-rules" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Turnos Ideais (por tipo)</label>
                            <input type="number" id="ideal-shifts" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Turnos Máximos (por tipo)</label>
                            <input type="number" id="max-shifts" value="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dias antes de Férias</label>
                            <input type="number" id="days-before-vacation" value="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Dias antes de Folga</label>
                            <input type="number" id="days-before-off" value="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ações -->
            <div class="mt-8">
                <button id="generate-schedule-btn" class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-md hover:bg-green-700 text-lg transition-transform transform hover:scale-105">
                    Gerar Escala
                </button>
                 <button id="clear-config-btn" class="w-full mt-4 px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                    Limpar Configuração
                </button>
            </div>
        </div>

        <!-- Painel da Escala -->
        <div class="w-full lg:w-2/3 p-6 bg-gray-50">
            <h1 class="text-2xl font-bold mb-6 text-gray-900">Escala Gerada</h1>
            <div id="output-panel" class="bg-white p-4 rounded-lg shadow">
                 <div id="loader-container" class="hidden flex-col items-center justify-center min-h-[400px]">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600">A otimizar a escala... Isto pode demorar um pouco.</p>
                </div>
                <div id="schedule-container">
                    <p id="placeholder-text" class="text-center text-gray-500 py-20">A escala gerada aparecerá aqui. Configure os dados e clique em "Gerar Escala".</p>
                    <div id="schedule-table-container" class="overflow-x-auto"></div>
                </div>
                <div id="summary-container" class="mt-6"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DADOS INICIAIS ---
            const initialData = {
                employees: ["Alexandre", "André", "Catarina", "Cátia", "Cláudio", "Inês", "José", "Marco", "Margarida", "Miguel", "Nuno", "Sandro", "Venâncio"],
                unavailability: {
                    "Alexandre": { vacation: [18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], off: [3, 9, 10, 17] },
                    "André": { vacation: [], off: [1, 2, 3, 11, 15, 16, 17, 25, 29, 30, 31] },
                    "Catarina": { vacation: [18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], off: [] },
                    "Cátia": { vacation: [], off: [2, 3, 9, 16, 17, 23, 31] },
                    "Cláudio": { vacation: [], off: [3, 4, 9, 16, 24, 25, 30] },
                    "Inês": { vacation: [25, 26, 27, 28, 29, 30, 31], off: [1, 2, 8, 9, 15, 22, 23] },
                    "José": { vacation: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13], off: [14, 24, 29, 30] },
                    "Marco": { vacation: [15, 16, 17, 18], off: [1, 2, 8, 22, 29] },
                    "Margarida": { vacation: [], off: [] },
                    "Miguel": { vacation: [], off: [7, 14, 21, 28] },
                    "Nuno": { vacation: [], off: [2, 10, 16, 17, 24, 30, 31] },
                    "Sandro": { vacation: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19], off: [3, 23, 31] },
                    "Venâncio": { vacation: [], off: [7, 14, 21, 28] }
                },
                preferredPairs: [
                    "Cláudio + Sandro", "Cláudio + Inês", "Cláudio + André", "Cláudio + Alexandre",
                    "Cláudio + Marco", "Cláudio + Cátia", "José + Margarida", "José + Catarina"
                ],
                preferredDays: [
                    "Venâncio: Terça-feira", "José: Terça-feira", "André: Segunda-feira", 
                    "Alexandre: Segunda-feira", "Sandro: Quarta-feira", "Marco: Quarta-feira"
                ],
                specialRules: [
                    "Catarina: FimDeSemanaNão",
                    "Catarina: Ideal1",
                    "Catarina: Max2"
                ]
            };

            // --- ELEMENTOS DO DOM ---
            const monthSelect = document.getElementById('month-select');
            const yearInput = document.getElementById('year-input');
            const employeeList = document.getElementById('employee-list');
            const newEmployeeNameInput = document.getElementById('new-employee-name');
            const addEmployeeBtn = document.getElementById('add-employee-btn');
            const employeeSelectCalendar = document.getElementById('employee-select-calendar');
            const calendarEl = document.getElementById('calendar');
            const markVacationBtn = document.getElementById('mark-vacation-btn');
            const markOffBtn = document.getElementById('mark-off-btn');
            const clearDayBtn = document.getElementById('clear-day-btn');
            const preferredPairsTextarea = document.getElementById('preferred-pairs');
            const preferredDaysTextarea = document.getElementById('preferred-days');
            const specialRulesTextarea = document.getElementById('special-rules');
            const generateBtn = document.getElementById('generate-schedule-btn');
            const clearConfigBtn = document.getElementById('clear-config-btn');
            const scheduleContainer = document.getElementById('schedule-container');
            const scheduleTableContainer = document.getElementById('schedule-table-container');
            const summaryContainer = document.getElementById('summary-container');
            const loaderContainer = document.getElementById('loader-container');
            const placeholderText = document.getElementById('placeholder-text');

            // --- ESTADO DA APLICAÇÃO ---
            let state = {
                employees: [],
                unavailability: {},
                selectedEmployeeCalendar: null,
                selectedDayCalendar: null,
                markingMode: null, // 'vacation' ou 'off'
            };

            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
            const dayNamesFull = ["Domingo", "Segunda-feira", "Terça-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "Sábado"];

            // --- FUNÇÕES DE INICIALIZAÇÃO E RENDERIZAÇÃO ---
            function setup() {
                // Preencher meses
                monthNames.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = name;
                    monthSelect.appendChild(option);
                });
                monthSelect.value = 7; // Agosto

                loadInitialData();
                updateEmployeeList();
                updateEmployeeSelects();
                renderCalendar();
                addEventListeners();
            }
            
            function loadInitialData() {
                state.employees = [...initialData.employees];
                state.unavailability = JSON.parse(JSON.stringify(initialData.unavailability));
                preferredPairsTextarea.value = initialData.preferredPairs.join('\n');
                preferredDaysTextarea.value = initialData.preferredDays.join('\n');
                specialRulesTextarea.value = initialData.specialRules.join('\n');
            }

            function updateEmployeeList() {
                employeeList.innerHTML = '';
                state.employees.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-gray-100 p-2 rounded';
                    div.innerHTML = `
                        <span class="text-sm">${name}</span>
                        <button data-name="${name}" class="remove-employee-btn text-red-500 hover:text-red-700 text-xs">Remover</button>
                    `;
                    employeeList.appendChild(div);
                });
                document.querySelectorAll('.remove-employee-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeEmployee(e.target.dataset.name));
                });
            }

            function updateEmployeeSelects() {
                employeeSelectCalendar.innerHTML = '';
                state.employees.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    employeeSelectCalendar.appendChild(option);
                });
                if (state.employees.length > 0) {
                    state.selectedEmployeeCalendar = state.employees[0];
                    employeeSelectCalendar.value = state.selectedEmployeeCalendar;
                }
            }

            function renderCalendar() {
                const month = parseInt(monthSelect.value);
                const year = parseInt(yearInput.value);
                calendarEl.innerHTML = '';

                // Cabeçalho dos dias da semana
                dayNames.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'font-bold text-sm text-gray-600';
                    dayEl.textContent = day;
                    calendarEl.appendChild(dayEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let i = 0; i < firstDayOfMonth; i++) {
                    calendarEl.appendChild(document.createElement('div'));
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.textContent = day;
                    dayEl.dataset.day = day;
                    dayEl.className = 'p-2 rounded cursor-pointer hover:bg-gray-200 calendar-day';

                    const unavailability = state.unavailability[state.selectedEmployeeCalendar] || { vacation: [], off: [] };
                    if (unavailability.vacation.includes(day)) {
                        dayEl.classList.add('vacation');
                    } else if (unavailability.off.includes(day)) {
                        dayEl.classList.add('off');
                    }
                    
                    if (day === state.selectedDayCalendar) {
                        dayEl.classList.add('selected');
                    }

                    dayEl.addEventListener('click', () => {
                        state.selectedDayCalendar = day;
                        renderCalendar(); // Re-render to show selection
                        if (state.markingMode) {
                            toggleDayMarking(day);
                        }
                    });
                    calendarEl.appendChild(dayEl);
                }
            }

            // --- FUNÇÕES DE MANIPULAÇÃO DE DADOS ---
            function addEmployee() {
                const name = newEmployeeNameInput.value.trim();
                if (name && !state.employees.includes(name)) {
                    state.employees.push(name);
                    state.unavailability[name] = { vacation: [], off: [] };
                    updateEmployeeList();
                    updateEmployeeSelects();
                    newEmployeeNameInput.value = '';
                }
            }

            function removeEmployee(name) {
                state.employees = state.employees.filter(e => e !== name);
                delete state.unavailability[name];
                updateEmployeeList();
                updateEmployeeSelects();
                if (state.selectedEmployeeCalendar === name) {
                    state.selectedEmployeeCalendar = state.employees.length > 0 ? state.employees[0] : null;
                }
                renderCalendar();
            }

            function toggleDayMarking(day) {
                if (!state.selectedEmployeeCalendar || !state.markingMode) return;
                
                const userUnavailability = state.unavailability[state.selectedEmployeeCalendar];
                const list = userUnavailability[state.markingMode];
                const otherList = userUnavailability[state.markingMode === 'vacation' ? 'off' : 'vacation'];

                const index = list.indexOf(day);
                const otherIndex = otherList.indexOf(day);

                if (otherIndex > -1) { // Clear from other list first
                    otherList.splice(otherIndex, 1);
                }

                if (index > -1) { // If already marked, unmark
                    list.splice(index, 1);
                } else { // Otherwise, mark it
                    list.push(day);
                }
                renderCalendar();
            }
            
            function clearDayMarking(day) {
                if (!state.selectedEmployeeCalendar || !day) return;
                const userUnavailability = state.unavailability[state.selectedEmployeeCalendar];
                const vacIndex = userUnavailability.vacation.indexOf(day);
                if (vacIndex > -1) userUnavailability.vacation.splice(vacIndex, 1);
                const offIndex = userUnavailability.off.indexOf(day);
                if (offIndex > -1) userUnavailability.off.splice(offIndex, 1);
                renderCalendar();
            }


            // --- EVENT LISTENERS ---
            function addEventListeners() {
                addEmployeeBtn.addEventListener('click', addEmployee);
                monthSelect.addEventListener('change', renderCalendar);
                yearInput.addEventListener('change', renderCalendar);
                employeeSelectCalendar.addEventListener('change', (e) => {
                    state.selectedEmployeeCalendar = e.target.value;
                    renderCalendar();
                });
                
                markVacationBtn.addEventListener('click', () => { 
                    state.markingMode = 'vacation';
                    markVacationBtn.classList.add('ring-2', 'ring-blue-700');
                    markOffBtn.classList.remove('ring-2', 'ring-red-700');
                });
                markOffBtn.addEventListener('click', () => { 
                    state.markingMode = 'off';
                    markOffBtn.classList.add('ring-2', 'ring-red-700');
                    markVacationBtn.classList.remove('ring-2', 'ring-blue-700');
                });
                clearDayBtn.addEventListener('click', () => {
                    if (state.selectedDayCalendar) {
                        clearDayMarking(state.selectedDayCalendar);
                    }
                });
                
                generateBtn.addEventListener('click', runGeneticAlgorithm);

                clearConfigBtn.addEventListener('click', () => {
                    if(confirm("Tem a certeza que quer limpar toda a configuração?")) {
                        state.employees = [];
                        state.unavailability = {};
                        preferredPairsTextarea.value = '';
                        preferredDaysTextarea.value = '';
                        specialRulesTextarea.value = '';
                        updateEmployeeList();
                        updateEmployeeSelects();
                        renderCalendar();
                    }
                });
            }

            // --- LÓGICA DO ALGORITMO GENÉTICO ---
            
            async function runGeneticAlgorithm() {
                loaderContainer.classList.remove('hidden');
                loaderContainer.classList.add('flex');
                scheduleContainer.classList.add('hidden');
                placeholderText.classList.add('hidden');
                summaryContainer.innerHTML = '';
                scheduleTableContainer.innerHTML = '';

                // Usar setTimeout para permitir que o UI atualize antes do processamento pesado
                setTimeout(() => {
                    // 1. Recolher toda a configuração
                    const config = {
                        month: parseInt(monthSelect.value),
                        year: parseInt(yearInput.value),
                        employees: [...state.employees],
                        unavailability: JSON.parse(JSON.stringify(state.unavailability)),
                        rules: {
                            idealShifts: parseInt(document.getElementById('ideal-shifts').value),
                            maxShifts: parseInt(document.getElementById('max-shifts').value),
                            daysBeforeVacation: parseInt(document.getElementById('days-before-vacation').value),
                            daysBeforeOff: parseInt(document.getElementById('days-before-off').value),
                            preferredPairs: preferredPairsTextarea.value.split('\n').filter(p => p.trim() !== '').map(p => p.split('+').map(n => n.trim()).sort()),
                            preferredDays: {},
                            specialRules: {}
                        },
                        gaParams: {
                            populationSize: 100,
                            generations: 150,
                            mutationRate: 0.1,
                            crossoverRate: 0.8,
                            tournamentSize: 5
                        }
                    };
                    
                    preferredDaysTextarea.value.split('\n').filter(l => l.includes(':')).forEach(line => {
                        const [name, day] = line.split(':').map(s => s.trim());
                        const dayIndex = dayNamesFull.indexOf(day);
                        if (name && dayIndex > -1) {
                           if (!config.rules.preferredDays[name]) config.rules.preferredDays[name] = [];
                           config.rules.preferredDays[name].push(dayIndex);
                        }
                    });

                    specialRulesTextarea.value.split('\n').filter(l => l.includes(':')).forEach(line => {
                        const [name, rule] = line.split(':').map(s => s.trim());
                        if (name && rule) {
                            if (!config.rules.specialRules[name]) config.rules.specialRules[name] = [];
                            config.rules.specialRules[name].push(rule);
                        }
                    });

                    // 2. Pré-calcular disponibilidade
                    const availabilityMatrix = precomputeAvailability(config);

                    // 3. Executar o algoritmo
                    let population = createInitialPopulation(config, availabilityMatrix);
                    let bestSchedule = population[0];
                    let bestFitness = -Infinity;

                    for (let gen = 0; gen < config.gaParams.generations; gen++) {
                        // Avaliar população
                        const fitnessScores = population.map(schedule => ({ schedule, fitness: calculateFitness(schedule, config, availabilityMatrix) }));
                        
                        // Encontrar o melhor da geração
                        for(const item of fitnessScores) {
                            if (item.fitness > bestFitness) {
                                bestFitness = item.fitness;
                                bestSchedule = item.schedule;
                            }
                        }

                        // Criar nova população
                        let newPopulation = [];
                        // Elitismo: manter o melhor
                        newPopulation.push(bestSchedule);

                        while (newPopulation.length < config.gaParams.populationSize) {
                            // Seleção (Torneio)
                            const parent1 = tournamentSelection(fitnessScores, config.gaParams.tournamentSize);
                            const parent2 = tournamentSelection(fitnessScores, config.gaParams.tournamentSize);
                            
                            let child = parent1;
                            // Crossover
                            if (Math.random() < config.gaParams.crossoverRate) {
                                child = crossover(parent1, parent2, config);
                            }
                            
                            // Mutação
                            if (Math.random() < config.gaParams.mutationRate) {
                                child = mutate(child, config, availabilityMatrix);
                            }
                            newPopulation.push(child);
                        }
                        population = newPopulation;
                    }
                    
                    // 4. Apresentar resultados
                    displaySchedule(bestSchedule, config);
                    displaySummary(bestSchedule, config);

                    loaderContainer.classList.add('hidden');
                    loaderContainer.classList.remove('flex');
                    scheduleContainer.classList.remove('hidden');
                }, 100);
            }

            function precomputeAvailability(config) {
                const { year, month, employees, unavailability, rules } = config;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const matrix = {};

                employees.forEach(emp => {
                    matrix[emp] = Array(daysInMonth + 1).fill(true);
                    const userUnav = unavailability[emp] || { vacation: [], off: [] };

                    // Marcar férias e folgas
                    userUnav.vacation.forEach(day => matrix[emp][day] = false);
                    userUnav.off.forEach(day => matrix[emp][day] = false);

                    // Marcar dias de bloqueio
                    userUnav.vacation.forEach(day => {
                        for (let i = 1; i <= rules.daysBeforeVacation; i++) {
                            if (day - i > 0) matrix[emp][day - i] = false;
                        }
                    });
                    userUnav.off.forEach(day => {
                        for (let i = 1; i <= rules.daysBeforeOff; i++) {
                            if (day - i > 0) matrix[emp][day - i] = false;
                        }
                    });
                });
                return matrix;
            }

            function createInitialPopulation(config, availabilityMatrix) {
                let population = [];
                const daysInMonth = new Date(config.year, config.month + 1, 0).getDate();

                for (let i = 0; i < config.gaParams.populationSize; i++) {
                    let schedule = [];
                    for (let day = 1; day <= daysInMonth; day++) {
                        const availableToday = config.employees.filter(emp => availabilityMatrix[emp][day]);
                        
                        let serviceEmp = "N/A";
                        let preventionEmp = "N/A";

                        if (availableToday.length >= 2) {
                           const shuffled = [...availableToday].sort(() => 0.5 - Math.random());
                           serviceEmp = shuffled[0];
                           preventionEmp = shuffled[1];
                        } else if (availableToday.length === 1) {
                           serviceEmp = availableToday[0];
                           preventionEmp = availableToday[0]; // Not ideal, will be penalized
                        }
                        
                        schedule[day] = { service: serviceEmp, prevention: preventionEmp };
                    }
                    population.push(schedule);
                }
                return population;
            }

            function calculateFitness(schedule, config, availabilityMatrix) {
                let fitness = 0;
                const { year, month, rules } = config;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const shiftCounts = {};
                config.employees.forEach(e => shiftCounts[e] = { service: 0, prevention: 0 });

                for (let day = 1; day <= daysInMonth; day++) {
                    if (!schedule[day]) continue;
                    const { service, prevention } = schedule[day];
                    const dayOfWeek = new Date(year, month, day).getDay();

                    // --- PENALIDADES PESADAS (HARD CONSTRAINTS) ---
                    // 1. Indisponibilidade
                    if (!availabilityMatrix[service]?.[day]) fitness -= 1000;
                    if (!availabilityMatrix[prevention]?.[day]) fitness -= 1000;
                    
                    // 2. Mesma pessoa em ambos os turnos
                    if (service === prevention && service !== "N/A") fitness -= 500;
                    
                    // 3. Dias consecutivos
                    if (day > 1 && schedule[day-1]) {
                        if (service !== "N/A" && (service === schedule[day-1].service || service === schedule[day-1].prevention)) fitness -= 1000;
                        if (prevention !== "N/A" && (prevention === schedule[day-1].service || prevention === schedule[day-1].prevention)) fitness -= 1000;
                    }

                    // 4. Regras especiais (hard)
                    if (rules.specialRules[service]?.includes('FimDeSemanaNão') && (dayOfWeek === 0 || dayOfWeek === 6)) fitness -= 1000;
                    if (rules.specialRules[prevention]?.includes('FimDeSemanaNão') && (dayOfWeek === 0 || dayOfWeek === 6)) fitness -= 1000;
                    
                    const venancioRule = rules.preferredDays['Venâncio']?.[0];
                    if(venancioRule !== undefined) {
                        if (service === 'Venâncio' && dayOfWeek !== venancioRule) fitness -= 500;
                        if (prevention === 'Venâncio' && dayOfWeek !== venancioRule) fitness -= 500;
                    }


                    // --- PENALIDADES LEVES (SOFT CONSTRAINTS) ---
                    // 1. Pares preferenciais
                    const currentPair = [service, prevention].sort();
                    const isPreferred = rules.preferredPairs.some(p => p[0] === currentPair[0] && p[1] === currentPair[1]);
                    if (isPreferred) {
                        fitness += 50; // Recompensa
                    } else {
                        fitness -= 10; // Penalidade leve
                    }

                    // 2. Dias preferenciais
                    if (rules.preferredDays[service]?.includes(dayOfWeek)) fitness += 20;
                    if (rules.preferredDays[prevention]?.includes(dayOfWeek)) fitness += 20;

                    // Contagem de turnos
                    if (service !== "N/A") shiftCounts[service].service++;
                    if (prevention !== "N/A") shiftCounts[prevention].prevention++;
                }

                // 3. Penalidades de contagem de turnos (aplicadas no final)
                config.employees.forEach(emp => {
                    const counts = shiftCounts[emp];
                    let idealService = rules.idealShifts;
                    let idealPrevention = rules.idealShifts;
                    let maxService = rules.maxShifts;
                    let maxPrevention = rules.maxShifts;
                    
                    // Aplicar regras especiais de contagem
                    if (rules.specialRules[emp]) {
                        rules.specialRules[emp].forEach(rule => {
                            if(rule.startsWith('Ideal')) {
                                idealService = idealPrevention = parseInt(rule.replace('Ideal', ''));
                            }
                            if(rule.startsWith('Max')) {
                                maxService = maxPrevention = parseInt(rule.replace('Max', ''));
                            }
                        });
                    }

                    // Penalidade por exceder o máximo
                    if (counts.service > maxService) fitness -= (counts.service - maxService) * 200;
                    if (counts.prevention > maxPrevention) fitness -= (counts.prevention - maxPrevention) * 200;
                    
                    // Penalidade por desvio do ideal
                    fitness -= Math.abs(counts.service - idealService) * 10;
                    fitness -= Math.abs(counts.prevention - idealPrevention) * 10;
                });

                return fitness;
            }

            function tournamentSelection(fitnessScores, size) {
                let tournament = [];
                for (let i = 0; i < size; i++) {
                    const randomIndex = Math.floor(Math.random() * fitnessScores.length);
                    tournament.push(fitnessScores[randomIndex]);
                }
                return tournament.reduce((best, current) => current.fitness > best.fitness ? current : best).schedule;
            }

            function crossover(parent1, parent2, config) {
                const daysInMonth = new Date(config.year, config.month + 1, 0).getDate();
                const crossoverPoint = Math.floor(Math.random() * (daysInMonth - 1)) + 1;
                const child = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    child[day] = day <= crossoverPoint ? parent1[day] : parent2[day];
                }
                return child;
            }

            function mutate(schedule, config, availabilityMatrix) {
                const daysInMonth = new Date(config.year, config.month + 1, 0).getDate();
                const mutationPoint = Math.floor(Math.random() * (daysInMonth - 1)) + 1;
                
                const availableToday = config.employees.filter(emp => availabilityMatrix[emp][mutationPoint]);
                if (availableToday.length < 2) return schedule; // Não pode mutar se não há opções

                const newSchedule = [...schedule];
                const shuffled = [...availableToday].sort(() => 0.5 - Math.random());
                
                newSchedule[mutationPoint] = {
                    service: shuffled[0],
                    prevention: shuffled[1]
                };

                return newSchedule;
            }


            // --- FUNÇÕES DE APRESENTAÇÃO ---
            function displaySchedule(schedule, config) {
                const { year, month } = config;
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let html = `<table class="w-full border-collapse text-sm">`;
                html += `<thead><tr class="bg-gray-200">`;
                dayNames.forEach(name => html += `<th class="p-2 border">${name}</th>`);
                html += `</tr></thead><tbody>`;

                let dayCounter = 1;
                const weeks = Math.ceil((daysInMonth + firstDayOfMonth) / 7);
                
                for (let i = 0; i < weeks; i++) {
                    html += `<tr>`;
                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDayOfMonth || dayCounter > daysInMonth) {
                            html += `<td class="p-2 border bg-gray-50 h-28"></td>`;
                        } else {
                            const dayData = schedule[dayCounter];
                            const serviceEmp = dayData ? dayData.service : 'ERRO';
                            const preventionEmp = dayData ? dayData.prevention : 'ERRO';
                            html += `
                                <td class="p-2 border align-top h-28">
                                    <div class="font-bold text-gray-700">${dayCounter}</div>
                                    <div class="mt-1 text-blue-700">S: ${serviceEmp}</div>
                                    <div class="mt-1 text-red-700">P: ${preventionEmp}</div>
                                </td>`;
                            dayCounter++;
                        }
                    }
                    html += `</tr>`;
                }

                html += `</tbody></table>`;
                scheduleTableContainer.innerHTML = html;
            }

            function displaySummary(schedule, config) {
                const shiftCounts = {};
                config.employees.forEach(e => shiftCounts[e] = { service: 0, prevention: 0 });
                
                schedule.forEach((day, index) => {
                    if(day) {
                        if(day.service && shiftCounts[day.service]) shiftCounts[day.service].service++;
                        if(day.prevention && shiftCounts[day.prevention]) shiftCounts[day.prevention].prevention++;
                    }
                });

                let html = `<h3 class="text-lg font-semibold mb-3">Resumo de Turnos</h3>`;
                html += `<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">`;
                config.employees.forEach(emp => {
                    const counts = shiftCounts[emp];
                    html += `
                        <div class="bg-gray-100 p-3 rounded-md">
                            <p class="font-bold text-gray-800">${emp}</p>
                            <p class="text-sm text-blue-800">Serviços: ${counts.service}</p>
                            <p class="text-sm text-red-800">Prevenções: ${counts.prevention}</p>
                            <p class="text-sm text-gray-600">Total: ${counts.service + counts.prevention}</p>
                        </div>
                    `;
                });
                html += `</div>`;
                summaryContainer.innerHTML = html;
            }

            // --- INICIAR APLICAÇÃO ---
            setup();
        });
    </script>
</body>
</html>
